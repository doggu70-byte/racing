{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - ê²½ë§ˆ ì˜ˆì¸¡ ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
<style>
.prediction-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
    margin-bottom: 15px;
}

.prediction-card.ai-model {
    border-left-color: #28a745;
}

.prediction-card.user-model {
    border-left-color: #17a2b8;
}

.prediction-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.horse-prediction-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.horse-prediction-item:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.rank-badge {
    font-size: 1.2em;
    font-weight: bold;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rank-1 { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; }
.rank-2 { background: linear-gradient(45deg, #C0C0C0, #A9A9A9); color: white; }
.rank-3 { background: linear-gradient(45deg, #CD7F32, #B87333); color: white; }
.rank-other { background: #6c757d; color: white; }

.probability-bar {
    height: 20px;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
}

.probability-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
}

.prob-high { background: linear-gradient(90deg, #28a745, #20c997); }
.prob-medium { background: linear-gradient(90deg, #ffc107, #fd7e14); }
.prob-low { background: linear-gradient(90deg, #dc3545, #e83e8c); }

.weight-slider {
    width: 100%;
}

.model-comparison {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.parameter-control {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.accuracy-badge {
    font-size: 0.8em;
    padding: 4px 8px;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

/* AI ì˜ˆì¸¡ ëª¨ë¸ ê³ ê¸‰ ìŠ¤íƒ€ì¼ */
.ai-enhanced {
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
    background: #fff;
}

.ai-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 1.5rem;
    position: relative;
}

.ai-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
    opacity: 0.3;
}

.ai-icon-wrapper {
    position: relative;
    z-index: 2;
}

.ai-icon {
    font-size: 2rem;
    color: #fff;
    animation: pulse 2s ease-in-out infinite alternate;
}

@keyframes pulse {
    from { transform: scale(1); opacity: 0.8; }
    to { transform: scale(1.05); opacity: 1; }
}

.ai-stats {
    position: relative;
    z-index: 2;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 0.75rem;
    backdrop-filter: blur(10px);
}

.stat-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
}

.stat-label {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.8);
    margin-top: 2px;
}

.ai-body {
    padding: 1.5rem;
    background: linear-gradient(180deg, #f8f9ff 0%, #fff 100%);
}

/* AI ì˜ˆì¸¡ ê²°ê³¼ ì•„ì´í…œ ìŠ¤íƒ€ì¼ ê°œì„  */
.ai-enhanced .horse-prediction-item {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ai-enhanced .horse-prediction-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, #667eea, #764ba2);
}

.ai-enhanced .horse-prediction-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102,126,234,0.15);
}

.ai-enhanced .rank-badge {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    font-weight: bold;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.ai-enhanced .rank-badge.rank-1 {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #333;
    box-shadow: 0 4px 15px rgba(255,215,0,0.4);
}

.ai-enhanced .rank-badge.rank-2 {
    background: linear-gradient(135deg, #c0c0c0, #e5e5e5);
    color: #333;
    box-shadow: 0 4px 15px rgba(192,192,192,0.4);
}

.ai-enhanced .rank-badge.rank-3 {
    background: linear-gradient(135deg, #cd7f32, #daa520);
    color: #fff;
    box-shadow: 0 4px 15px rgba(205,127,50,0.4);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-brain"></i> {{ title }}</h2>
                    <p class="text-muted">AI ì˜ˆì¸¡ê³¼ ì‚¬ìš©ì ì„¤ì • ì˜ˆì¸¡ì„ ë¹„êµí•´ë³´ì„¸ìš”</p>
                </div>
                <div>
                    <a href="{% url 'racing:schedule' %}" class="btn btn-outline-primary">
                        <i class="fas fa-calendar-alt"></i> ê²½ì£¼ ì¼ì •
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ê²½ì£¼ ì„ íƒ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-search"></i> ê²½ì£¼ ì„ íƒ</h5>
                    <form id="raceSelectionForm" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">ê²½ì£¼ì¼ ì„ íƒ</label>
                            <div class="btn-group w-100" role="group" aria-label="ê²½ì£¼ì¼ ì„ íƒ">
                                <input type="radio" class="btn-check" name="dayOptions" id="fridayBtn" autocomplete="off">
                                <label class="btn btn-outline-primary" for="fridayBtn">ê¸ˆìš”ì¼</label>
                                
                                <input type="radio" class="btn-check" name="dayOptions" id="saturdayBtn" autocomplete="off">
                                <label class="btn btn-outline-primary" for="saturdayBtn">í† ìš”ì¼</label>
                                
                                <input type="radio" class="btn-check" name="dayOptions" id="sundayBtn" autocomplete="off">
                                <label class="btn btn-outline-primary" for="sundayBtn">ì¼ìš”ì¼</label>
                            </div>
                            <input type="hidden" id="raceDate">
                        </div>
                        <div class="col-md-4">
                            <label for="raceNo" class="form-label">ê²½ì£¼ ì„ íƒ (ì‹œê°„ìˆœ)</label>
                            <div class="race-scroll-container" style="max-height: 120px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                                <div class="list-group list-group-flush" id="raceList">
                                    <!-- ê²½ì£¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                            <input type="hidden" id="raceNo">
                            <input type="hidden" id="meet">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-success w-100 mb-2">
                                <i class="fas fa-magic"></i> ì˜ˆì¸¡ ì‹œì‘
                            </button>
                            <button type="button" id="resetBtn" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-redo"></i> ì´ˆê¸°í™”
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ì˜ˆì¸¡ ê²°ê³¼ -->
    <div id="predictionResults" style="display: none;">
        <!-- ëª¨ë¸ ë¹„êµ ìš”ì•½ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="model-comparison">
                    <h5><i class="fas fa-chart-line"></i> ì˜ˆì¸¡ ëª¨ë¸ ë¹„êµ</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-robot text-success"></i> AI ìë™ ì˜ˆì¸¡</span>
                                <span class="badge bg-success accuracy-badge" id="aiAccuracy">ì •í™•ë„: -</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-cog text-info"></i> ì‚¬ìš©ì ì„¤ì • ì˜ˆì¸¡</span>
                                <button class="btn btn-sm btn-info" id="adjustWeightsBtn">
                                    <i class="fas fa-sliders-h"></i> ê°€ì¤‘ì¹˜ ì¡°ì •
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜ˆì¸¡ ê²°ê³¼ ë¹„êµ -->
        <div class="row">
            <!-- AI ì˜ˆì¸¡ ê²°ê³¼ -->
            <div class="col-lg-6 mb-4">
                <div class="card prediction-card ai-model ai-enhanced">
                    <div class="card-header ai-header">
                        <div class="d-flex align-items-center">
                            <div class="ai-icon-wrapper me-3">
                                <i class="fas fa-brain ai-icon"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="mb-1 text-white">ğŸ¤– AI ìë™ ì˜ˆì¸¡</h5>
                                <small class="text-light opacity-75">ë”¥ëŸ¬ë‹ ê¸°ë°˜ ìŠ¹ë¥  ë¶„ì„</small>
                            </div>
                            <div class="ai-version">
                                <span class="badge bg-light text-dark">v<span id="aiVersion">1.0</span></span>
                            </div>
                        </div>
                        <div class="ai-stats mt-2">
                            <div class="row">
                                <div class="col-4 text-center">
                                    <div class="stat-value" id="aiAccuracy">--</div>
                                    <div class="stat-label">ì •í™•ë„</div>
                                </div>
                                <div class="col-4 text-center">
                                    <div class="stat-value" id="aiConfidence">--</div>
                                    <div class="stat-label">ì‹ ë¢°ë„</div>
                                </div>
                                <div class="col-4 text-center">
                                    <div class="stat-value" id="aiProcessed">--</div>
                                    <div class="stat-label">ë¶„ì„ ì™„ë£Œ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body ai-body">
                        <div id="aiPredictions">
                            <!-- AI ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš©ì íŒŒë¼ë¯¸í„° ì˜ˆì¸¡ ê²°ê³¼ -->
            <div class="col-lg-6 mb-4">
                <div class="card prediction-card user-model">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-user-cog"></i> ì‚¬ìš©ì ì„¤ì • ì˜ˆì¸¡</h6>
                        <small class="text-muted">ì»¤ìŠ¤í…€</small>
                    </div>
                    <div class="card-body position-relative">
                        <div id="userLoadingOverlay" class="loading-overlay" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="userPredictions">
                            <!-- ì‚¬ìš©ì ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ìƒíƒœ -->
    <div id="loadingState" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">ì˜ˆì¸¡ ëª¨ë¸ì„ ì‹¤í–‰í•˜ëŠ” ì¤‘...</p>
    </div>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div id="errorMessage" class="alert alert-danger" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="errorText"></span>
    </div>
</div>

<!-- ê°€ì¤‘ì¹˜ ì¡°ì • ëª¨ë‹¬ -->
<div class="modal fade" id="weightsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sliders-h"></i> ì‚¬ìš©ì íŒŒë¼ë¯¸í„° ê°€ì¤‘ì¹˜ ì¡°ì •
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">ê° ìš”ì†Œì˜ ì¤‘ìš”ë„ë¥¼ ì¡°ì •í•´ì„œ ë‚˜ë§Œì˜ ì˜ˆì¸¡ ëª¨ë¸ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                
                <div id="weightControls">
                    <!-- ê°€ì¤‘ì¹˜ ìŠ¬ë¼ì´ë”ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="mt-3 p-3 bg-light rounded">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        ì´ ê°€ì¤‘ì¹˜ëŠ” ìë™ìœ¼ë¡œ 100%ë¡œ ì¡°ì •ë©ë‹ˆë‹¤.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="resetWeightsBtn">
                    <i class="fas fa-undo"></i> ê¸°ë³¸ê°’ ë³µì›
                </button>
                <button type="button" class="btn btn-primary" id="applyWeightsBtn">
                    <i class="fas fa-check"></i> ì ìš©í•˜ê³  ë‹¤ì‹œ ì˜ˆì¸¡
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentRaceData = null;
    
    // URL íŒŒë¼ë¯¸í„° ìë™ ë¡œë“œ
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('meet') && urlParams.get('date') && urlParams.get('race_no')) {
        $('#meet').val(urlParams.get('meet'));
        $('#raceDate').val(urlParams.get('date'));
        $('#raceNo').val(urlParams.get('race_no'));
        
        // ìë™ìœ¼ë¡œ ì˜ˆì¸¡ ì‹œì‘
        setTimeout(() => {
            loadPredictions();
        }, 500);
    }
    let currentWeights = {
        'recent_performance': 25.0,
        'jockey_skill': 20.0,
        'trainer_skill': 15.0,
        'horse_condition': 15.0,
        'distance_experience': 10.0,
        'track_condition': 8.0,
        'odds_factor': 7.0
    };

    const weightLabels = {
        'recent_performance': 'ìµœê·¼ ì„±ì ',
        'jockey_skill': 'ê¸°ìˆ˜ ì‹¤ë ¥',
        'trainer_skill': 'ì¡°êµì‚¬ ì‹¤ë ¥',
        'horse_condition': 'ë§ ì»¨ë””ì…˜',
        'distance_experience': 'ê±°ë¦¬ ê²½í—˜',
        'track_condition': 'íŠ¸ë™ ìƒíƒœ',
        'odds_factor': 'ë°°ë‹¹ë¥  ìš”ì†Œ'
    };

    // í¼ ì œì¶œ
    $('#raceSelectionForm').submit(function(e) {
        e.preventDefault();
        loadPredictions();
    });

    // ì´ˆê¸°í™” ë²„íŠ¼
    $('#resetBtn').click(function() {
        $('input[name="dayOptions"]').prop('checked', false);
        $('#raceDate').val('');
        $('#raceNo').val('');
        $('#raceList').empty();
        $('#predictionResults').hide();
        $('#errorMessage').hide();
    });

    // ê¸ˆí† ì¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('input[name="dayOptions"]').change(function() {
        if ($(this).is(':checked')) {
            const selectedDay = $(this).attr('id');
            const date = getDateByDay(selectedDay);
            $('#raceDate').val(date);
            loadRaceSchedule();
        }
    });

    // íŠ¹ì • ìš”ì¼ì˜ ë‚ ì§œ ê³„ì‚°
    function getDateByDay(dayId) {
        const today = new Date();
        const currentDay = today.getDay(); // 0=ì¼, 1=ì›”, ..., 6=í† 
        let targetDay;
        
        switch(dayId) {
            case 'fridayBtn': targetDay = 5; break; // ê¸ˆìš”ì¼
            case 'saturdayBtn': targetDay = 6; break; // í† ìš”ì¼  
            case 'sundayBtn': targetDay = 0; break; // ì¼ìš”ì¼
            default: targetDay = 5; break;
        }
        
        let daysUntilTarget = targetDay - currentDay;
        if (daysUntilTarget < 0) {
            daysUntilTarget += 7; // ë‹¤ìŒ ì£¼
        }
        if (daysUntilTarget === 0 && today.getHours() >= 18) {
            daysUntilTarget = 7; // ì˜¤ëŠ˜ ì˜¤í›„ 6ì‹œ ì´í›„ë©´ ë‹¤ìŒ ì£¼
        }
        
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + daysUntilTarget);
        
        return targetDate.toISOString().split('T')[0].replace(/-/g, '');
    }

    // ê²½ì£¼ ì¼ì • ì¡°íšŒ (ëª¨ë“  ê²½ë§ˆì¥)
    function loadRaceSchedule() {
        const date = $('#raceDate').val();
        
        if (!date) return;
        
        // ëª¨ë“  ê²½ë§ˆì¥ ì¡°íšŒ (ì„œìš¸=1, ë¶€ì‚°=2, ì œì£¼=3)
        const trackPromises = [1, 2, 3].map(meet => {
            return $.ajax({
                url: '/api/schedule/',
                data: { meet: meet, date: date }
            }).then(response => {
                if (response.success && response.data && response.data.length > 0) {
                    return response.data.map(race => ({
                        ...race,
                        meet: meet,
                        trackName: meet === 1 ? 'ì„œ' : meet === 2 ? 'ë¶€' : 'ì œ'
                    }));
                }
                return [];
            }).catch(() => []);
        });
        
        Promise.all(trackPromises).then(results => {
            const allRaces = results.flat();
            if (allRaces.length > 0) {
                displayRaceList(allRaces);
            } else {
                $('#raceList').html('<div class="alert alert-warning m-2">í•´ë‹¹ ì¼ìì— ê²½ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
            }
        });
    }

    // ê²½ì£¼ ëª©ë¡ í‘œì‹œ (ì‹œê°„ìˆœ ì •ë ¬, ì„œ1R ë¶€1R í˜•íƒœ)
    function displayRaceList(races) {
        const $raceList = $('#raceList');
        $raceList.empty();
        
        if (!races || races.length === 0) {
            $raceList.html('<div class="alert alert-warning m-2">ê²½ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
            return;
        }
        
        // ì‹œê°„ìˆœ ì •ë ¬ (ì¶œë°œì‹œê°„ ê¸°ì¤€)
        races.sort((a, b) => {
            // ì‹œê°„ì„ ìˆ«ìë¡œ ë³€í™˜í•´ì„œ ë¹„êµ (ì˜ˆ: "14:20" -> 1420)
            const timeA = a.rcTime ? parseInt(a.rcTime.replace(':', '')) : 0;
            const timeB = b.rcTime ? parseInt(b.rcTime.replace(':', '')) : 0;
            
            // ì‹œê°„ì´ ê°™ìœ¼ë©´ ê²½ì£¼ë²ˆí˜¸ë¡œ ì •ë ¬
            if (timeA === timeB) {
                return parseInt(a.rcNo) - parseInt(b.rcNo);
            }
            
            return timeA - timeB;
        });
        
        races.forEach(race => {
            const raceItem = $(`
                <a href="#" class="list-group-item list-group-item-action race-item" 
                   data-race-no="${race.rcNo}" data-meet="${race.meet}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${race.trackName}${race.rcNo}R</strong>
                            <small class="text-muted d-block">${race.rcTime} â€¢ ${race.rcDist}m</small>
                        </div>
                        <span class="badge bg-primary">${race.chulNo || 0}ë§ˆë¦¬</span>
                    </div>
                </a>
            `);
            $raceList.append(raceItem);
        });
    }

    // ê²½ì£¼ ì„ íƒ ì´ë²¤íŠ¸
    $(document).on('click', '.race-item', function(e) {
        e.preventDefault();
        
        // ë‹¤ë¥¸ í•­ëª©ë“¤ ì„ íƒ í•´ì œ
        $('.race-item').removeClass('active');
        
        // í˜„ì¬ í•­ëª© ì„ íƒ
        $(this).addClass('active');
        
        // ê²½ì£¼ë²ˆí˜¸ì™€ ê²½ë§ˆì¥ ì„¤ì •
        const raceNo = $(this).data('race-no');
        const meet = $(this).data('meet');
        $('#raceNo').val(raceNo);
        $('#meet').val(meet);
    });

    // ê°€ì¤‘ì¹˜ ì¡°ì • ë²„íŠ¼
    $('#adjustWeightsBtn').click(function() {
        showWeightsModal();
    });

    // ê°€ì¤‘ì¹˜ ì ìš© ë²„íŠ¼
    $('#applyWeightsBtn').click(function() {
        applyUserWeights();
        $('#weightsModal').modal('hide');
    });

    // ê°€ì¤‘ì¹˜ ì´ˆê¸°í™” ë²„íŠ¼
    $('#resetWeightsBtn').click(function() {
        resetWeights();
    });

    function loadPredictions() {
        const meet = $('#meet').val();
        const date = $('#raceDate').val();
        const raceNo = $('#raceNo').val();

        if (!date || !raceNo) {
            showError('ê²½ì£¼ì¼ê³¼ ê²½ì£¼ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        // UI ì´ˆê¸°í™”
        $('#errorMessage').hide();
        $('#predictionResults').hide();
        $('#loadingState').show();

        // API í˜¸ì¶œ
        $.ajax({
            url: '/api/prediction/',
            data: {
                meet: meet,
                date: date,
                race_no: raceNo
            },
            success: function(response) {
                $('#loadingState').hide();
                if (response.success) {
                    currentRaceData = response.data;
                    showPredictionResults(response.data);
                    $('#predictionResults').show();
                } else {
                    showError(response.error);
                }
            },
            error: function(xhr, status, error) {
                $('#loadingState').hide();
                showError('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            }
        });
    }

    function showPredictionResults(data) {
        // AI ëª¨ë¸ ê²°ê³¼
        if (data.ai_model && data.ai_model.predictions) {
            $('#aiVersion').text(data.ai_model.version || '1.0');
            $('#aiAccuracy').text(`${(data.ai_model.accuracy || 0).toFixed(1)}%`);
            
            // AI í†µê³„ ì—…ë°ì´íŠ¸
            const avgConfidence = data.ai_model.predictions.reduce((sum, pred) => 
                sum + (pred.win_probability || 0), 0) / data.ai_model.predictions.length;
            $('#aiConfidence').text(`${avgConfidence.toFixed(1)}%`);
            $('#aiProcessed').text(`${data.ai_model.predictions.length}ë§ˆë¦¬`);
            
            displayPredictions('#aiPredictions', data.ai_model.predictions, 'ai');
        }

        // ì‚¬ìš©ì ëª¨ë¸ ê²°ê³¼
        if (data.user_model && data.user_model.predictions) {
            displayPredictions('#userPredictions', data.user_model.predictions, 'user');
        }
    }

    function displayPredictions(container, predictions, modelType) {
        const $container = $(container);
        $container.empty();

        if (!predictions || predictions.length === 0) {
            $container.html('<div class="alert alert-warning">ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
            return;
        }

        predictions.forEach((pred, index) => {
            const card = createPredictionCard(pred, index + 1, modelType);
            $container.append(card);
        });
    }

    function createPredictionCard(prediction, rank, modelType) {
        const probability = parseFloat(prediction.win_probability || 0);
        const probClass = probability >= 70 ? 'prob-high' : 
                         probability >= 40 ? 'prob-medium' : 'prob-low';
        
        const rankClass = rank === 1 ? 'rank-1' : 
                         rank === 2 ? 'rank-2' : 
                         rank === 3 ? 'rank-3' : 'rank-other';

        return `
        <div class="horse-prediction-item p-3">
            <div class="d-flex align-items-center mb-2">
                <div class="rank-badge ${rankClass} rounded-circle me-3">
                    ${rank}
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1">
                        <span class="badge bg-primary me-2">${prediction.chul_no || prediction.gate_no || prediction.start_no || '?'}ë²ˆ</span>
                        ${prediction.horse_name}
                    </h6>
                    <small class="text-muted">ë“±ë¡ë²ˆí˜¸: ${prediction.horse_no}</small>
                </div>
                <div class="text-end">
                    <div class="h5 mb-0 ${probability >= 70 ? 'text-success' : probability >= 40 ? 'text-warning' : 'text-danger'}">
                        ${probability.toFixed(1)}%
                    </div>
                </div>
            </div>
            <div class="probability-bar bg-light">
                <div class="probability-fill ${probClass}" style="width: ${Math.max(probability, 5)}%"></div>
            </div>
            ${modelType === 'user' ? createParameterDetails(prediction) : ''}
        </div>`;
    }

    function createParameterDetails(prediction) {
        if (!prediction.parameter_scores) return '';
        
        let details = '<div class="mt-2"><small class="text-muted">íŒŒë¼ë¯¸í„° ì ìˆ˜:</small><div class="row mt-1">';
        
        Object.entries(prediction.parameter_scores).forEach(([param, score]) => {
            const label = weightLabels[param] || param;
            details += `
            <div class="col-6 col-md-4">
                <small>${label}: <strong>${score.toFixed(0)}ì </strong></small>
            </div>`;
        });
        
        details += '</div></div>';
        return details;
    }

    function showWeightsModal() {
        const modal = $('#weightsModal');
        const modalElement = modal.get(0);
        
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ì •ë¦¬
        modal.off();
        
        // ê¸°ì¡´ Bootstrap ì¸ìŠ¤í„´ìŠ¤ ì œê±°
        const existingInstance = bootstrap.Modal.getInstance(modalElement);
        if (existingInstance) {
            existingInstance.dispose();
        }
        
        const $controls = $('#weightControls');
        $controls.empty();

        Object.entries(currentWeights).forEach(([param, weight]) => {
            const label = weightLabels[param] || param;
            const control = createWeightControl(param, label, weight);
            $controls.append(control);
        });

        // ì •ë¦¬ ì´ë²¤íŠ¸ ë“±ë¡
        modal.one('hidden.bs.modal', function() {
            $('#weightControls').empty();
        });
        
        // ìƒˆ Bootstrap ì¸ìŠ¤í„´ìŠ¤ë¡œ ëª¨ë‹¬ í‘œì‹œ
        const bsModal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
        bsModal.show();
    }

    function createWeightControl(param, label, weight) {
        return `
        <div class="parameter-control">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0">${label}</label>
                <span class="badge bg-primary" id="weight-${param}-value">${weight.toFixed(1)}%</span>
            </div>
            <input type="range" class="weight-slider" 
                   id="weight-${param}" 
                   min="0" max="50" step="0.5" 
                   value="${weight}"
                   data-param="${param}">
        </div>`;
    }

    // ê°€ì¤‘ì¹˜ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
    $(document).on('input', '.weight-slider', function() {
        const param = $(this).data('param');
        const value = parseFloat($(this).val());
        currentWeights[param] = value;
        $(`#weight-${param}-value`).text(`${value.toFixed(1)}%`);
    });

    function resetWeights() {
        currentWeights = {
            'recent_performance': 25.0,
            'jockey_skill': 20.0,
            'trainer_skill': 15.0,
            'horse_condition': 15.0,
            'distance_experience': 10.0,
            'track_condition': 8.0,
            'odds_factor': 7.0
        };
        showWeightsModal();
    }

    function applyUserWeights() {
        if (!currentRaceData) return;

        $('#userLoadingOverlay').show();

        const meet = $('#meet').val();
        const date = $('#raceDate').val();
        const raceNo = $('#raceNo').val();

        // ê°€ì¤‘ì¹˜ ì ìš©í•´ì„œ ì¬ì˜ˆì¸¡
        $.ajax({
            url: `/api/prediction/?meet=${meet}&date=${date}&race_no=${raceNo}`,
            method: 'POST',
            data: JSON.stringify(currentWeights),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                $('#userLoadingOverlay').hide();
                if (response.success && response.data.user_model) {
                    displayPredictions('#userPredictions', response.data.user_model.predictions, 'user');
                }
            },
            error: function(xhr, status, error) {
                $('#userLoadingOverlay').hide();
                console.error('ê°€ì¤‘ì¹˜ ì ìš© ì˜¤ë¥˜:', error);
                console.error('ì‘ë‹µ:', xhr.responseText);
                showError('ê°€ì¤‘ì¹˜ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            }
        });
    }

    function showError(message) {
        $('#errorText').text(message);
        $('#errorMessage').show();
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}